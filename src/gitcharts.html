<!DOCTYPE html><!-- (c) 2015 Briskat, http://www.briskat.com, License: MIT -->
<html lang="en">
<head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="Git dashboard">
    <meta name="author" content="Briskat">

    <title>Briskat - gitcharts</title>
	<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/css/bootstrap.min.css">
    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->
	<script type="text/javascript" src="https://www.google.com/jsapi"></script>
	<script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.2/jquery.min.js"></script>
	<script type="text/javascript" src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/js/bootstrap.min.js"></script>
	<script type="text/javascript" src="/assets/jquery.history.js"></script>
	<script type="text/javascript">
	google.load('visualization', '1.0', {'packages':['corechart']});
	google.setOnLoadCallback(initMe);

	var GS = new Array(); // reuse graph
	var S = { tab : 0,
			days : 10,
		};

	function initMe() {
		var tab=parseInt(getUrlParameter('tab'));
		if (tab > 0 && tab < 4) { S['tab']=tab; }
		var days=parseInt(getUrlParameter('days'));
		if (days > 0 && days < 366) { S['days']=days; }
		loadProjects();
		drawSummary();

		$("#dashtabs li:eq("+S['tab']+") a").tab('show');
		$(window).resize(function(){ refresh(S['days'],0); });
		$("#day_minus").click(function() { S['days']=refresh(S['days'],-10); addHistory(); });
		$("#day_plus").click(function() { S['days']=refresh(S['days'],10); addHistory(); });
		$("#project_div").change(function() { refresh(S['days'],0); drawSummary(); addHistory(); });

		$(document).ready(function(){
			$('a[data-toggle="tab"]').on('shown.bs.tab', function(e){
				var act = $(e.target).attr('href'); // Get the name of active tab
				S['tab'] = act.substring(4, act.length);
				GS = new Array();
				refresh(S['days'],0);
				addHistory();
			});
		});
		$(function() {
			if ( History.enabled ) {
				History.Adapter.bind(window,'statechange',function() {
					var s = History.getState();
					var url = s.url.split('?')[1];
					if ( S['days'] != getUrlParameter( 'days', url )
						|| S['tab'] != getUrlParameter( 'tab', url )
						|| getActiveProject() != getUrlParameter( 'proj', url ) ) {
						location.reload();
					}
				});
			}
		});
		refresh(S['days'],0);
	}

	function addHistory () {
		if ( History.enabled ) {
			History.pushState(null, null, "?proj=" + encodeURIComponent(getActiveProject())
				+ "&days=" + S['days'] + "&tab=" + S['tab']);
		}
	}

	function dump(obj) {
		prompt('Dump', JSON.stringify(obj));
	}

	function getUrlParameter(sParam,Url) {
		var sPageURL = window.location.search.substring(1);
		if ( Url ) { sPageURL = Url; }
		var sURLVariables = sPageURL.split('&');
		for (var i = 0; i < sURLVariables.length; i++) {
			var sParameterName = sURLVariables[i].split('=');
			if (sParameterName[0] == sParam) {
				return  decodeURIComponent(sParameterName[1]);
			}
		}
	}

	function loadProjects() {
		var jsonData = getData("/api/p/");
		var options = $("#project_div");
		var proj=getUrlParameter('proj');
		$.each(jsonData['projects'], function() {
			if ( this.name == proj ) {
				options.append($("<option selected/>").val(this.name).text(this.name));
			} else {
				options.append($("<option />").val(this.name).text(this.name));
			}
		});
	}

	function getData(url) {
		return $.ajax({
			url: url,
			dataType: "json",
			async: false
		}).responseJSON;
	}

	function drawSummary() {
		var jsonData = getData("/api/p/" + $('#project_div').val() + "/r/summary");
		var metrics=jsonData['report']['metrics'];
		$( "span#summary" ).html( ' <b>' + metrics['commits'][0] + '</b><small> commits,</small> <b>'
			+ metrics['authors'][0] + '</b><small> authors, </small> <b>~'
			+ Math.round(metrics['size'][0]/1048576) + '</b><small>MB, </small><b>~'
			+ metrics['files'][0] + '</b><small> files</small>');
	}

	function drawDaySummary(f,jsonData) {
		var Tot = new Object();
		Tot['_cnt'] = jsonData['x'].length;
		for ( var key in jsonData['metrics'] ) {
			var cnt = 0;
			for ( var i in jsonData['metrics'][key] ) {
				cnt = cnt + jsonData['metrics'][key][i];
			}
			Tot[key] = cnt;
		};
		$( "span#last_days_sum" ).html(f(Tot));
	}

	function order(a, b) {
		if (b[1] == a[1]) { return 0; }
		if (b[1] > a[1]) { return 1; }
		else { return -1; }
	}
	function order_abs(a, b) {
		if (Math.abs(b[1]) == Math.abs(a[1])) { return 0; }
		if (Math.abs(b[1]) > Math.abs(a[1])) { return 1; }
		else { return -1; }
	}
	function order_2val(a, b) {
		if (b[1] == a[1] && b[2] == a[2] ) { return 0; }
		if (b[1] >= b[2] && b[1] > a[1] && b[1] > a[2] ) { return 1; }
		if (b[2] > b[1] && b[2] > a[1] && b[2] > a[2] ) { return 1; }
		else { return -1; }
	}

	function metric2Table(jsonData,xname,Report,fsort,limit) {
		var Table = new google.visualization.DataTable();
		Table.addColumn('string', xname);
		for ( var j in Report ) {
			if ( Report[j] ) {
				Table.addColumn('number', Report[j]);
			} else {
				Table.addColumn('string', Report[j]);
			}
		}

		var metrics=jsonData['report']['metrics'];
		var rows = new Array();
		for ( var x_idx in jsonData['report']['x'] ) {
			var row=[];
			row.push(jsonData['report']['x'][x_idx]);
			for ( var j in Report ) {
				if ( Report[j] ) {
					row.push(metrics[Report[j]][x_idx]);
				} else {
					row.push('');
				}
			}
			rows.push(row);
		}
		if ( fsort ) {
			rows.sort(fsort)
		}
		if ( limit ) {
			Table.addRows(rows.slice(0,limit));
		} else {
			Table.addRows(rows);
		}
		return Table;
	}

	function drawDashboard(Project,days) {
			gv = google.visualization;
			var actTID = S['tab'];
			var Iurl = 0;
			var Ixaxis = 1;
			var Igrid = 2;
			var Isub = 3;
			var Ilistener = 4;
			var tab = [
				[
					[
						"/r/last_x_days?days=" + days,
						'date',
						[
							[ gv.ColumnChart, 'commits_div', [ 'commits' ], { 'height':350 } ],
							[ gv.ColumnChart, 'size_div',    [ 'size' ], { 'height':350 } ],
							[ gv.LineChart,   'files_div',   [ 'files_c', 'files_r', 'files_a' ], { 'height':350 } ],
							[ gv.LineChart,   'lines_div',   [ 'lines_a', 'lines_r' ], { 'height':350 } ],
						],
						function (T) { return '<b>' + T['commits'] + '</b><small> commits, </small>'
								+ 	'<b>' + Math.round(T['size']/1024) + '</b><small>kB, </small>'
								+ 	'<b class="text-success">+' + T['files_a'] + '</b><small>, </small>'
								+ 	'<b class="text-danger">-' + T['files_r'] + '</b><small> files</small>'
						}
					]
				],
				[
					[
						"/r/last_x_days_c?days=" + days,
						'author',
						[
							[ gv.ColumnChart, 'big_commit_div', [ 'size' ],
								{ 'height':650,
									title : 'Click on column for the detail.'
								},
								order_abs,
								12
							]
						],
						function (T) { return '' },
						'listener'
					]
				],
				[
					[
						"/r/last_x_days_a?days=" + days,
						'author',
						[
							[ gv.PieChart, 'commit_chart_div', [ 'commits' ],
								{ 'height':350,
								},
								order
							],
							[ gv.ColumnChart, 'commit_size_div', [ 'size' ],
								{ 'height':350,
								},
								order_abs,
								8
							],
							[ gv.ColumnChart, 'author_lines', [ 'lines_a', 'lines_r' ],
								{ 'height':350,
								},
								order_2val,
								8
							]
						],
						function (T) { return '<b>' + T['commits'] + '</b><small> commits, </small>'
								+ '<b>' + T['_cnt'] + '</b><small> authors, </small>'
								+ 	'<b>' + Math.round(T['size']/1024) + '</b><small>kB, </small>'
								+ 	'<b class="text-success">+' + T['lines_a'] + '</b><small>, </small>'
								+ 	'<b class="text-danger">-' + T['lines_r'] + '</b><small> lines</small>'
						}
					]
				],
				[
					[
						"/r/last_x_days_a?days=" + days,
						'author',
						[
							[ gv.BubbleChart, 'bubble_div', [ 'lines_a', 'lines_r', 'size', 'commits' ],
								{
									hAxis: {title: 'Lines Added'},
									vAxis: {title: 'Lines Removed'},
									explorer: { maxZoomOut: 20 },
									'height':650,
								}
							]
						],
						function (T) { return '<b>' + T['commits'] + '</b><small> commits, </small>'
								+ '<b>' + T['_cnt'] + '</b><small> authors, </small>'
								+ 	'<b>' + Math.round(T['size']/1024) + '</b><small>kB, </small>'
								+ 	'<b class="text-success">+' + T['lines_a'] + '</b><small>, </small>'
								+ 	'<b class="text-danger">-' + T['lines_r'] + '</b><small> lines</small>'
						}
					]
				]
			];

			if ( GS[actTID] == undefined ) {
				var GST = new Array(); // reuse graph
				for ( var i in tab[actTID] )
					for ( var j in tab[actTID][i][Igrid] )
						GST.push(new tab[actTID][i][Igrid][j][0](document.getElementById(tab[actTID][i][Igrid][j][1])));
				GS[actTID] = GST;
			}

			var g_idx=0;
			for ( var i in tab[actTID] ) {
				var Data = getData("/api/p/" + Project + tab[actTID][i][Iurl]);
				drawDaySummary(tab[actTID][i][Isub], Data['report']);
				for ( var j in tab[actTID][i][Igrid] ) {
					var Table = metric2Table(
									Data,
									tab[actTID][i][Ixaxis],
									tab[actTID][i][Igrid][j][2],
									tab[actTID][i][Igrid][j][4],
									tab[actTID][i][Igrid][j][5]
								);
					var chart=GS[actTID][g_idx++];
					if ( tab[actTID][i][Ilistener] ) {
						addListener(chart,Table);
					}
					chart.draw(Table, tab[actTID][i][Igrid][j][3]);
				}
			}

	}

	function githubSucc( response ) {
		var meta = response.meta;
		var data = response.data;
		var Msg = "No detail available.";
		if ( meta["X-RateLimit-Remaining"] == 0 ) {
			var d = new Date(0);
			d.setUTCSeconds(meta["X-RateLimit-Reset"]);
			Msg = 'No commit detail available from GitHub until ' + d.toString();
		} else {
			Msg = data['message'].replace(/\n\n/, "</h3><br /></br>");
			Msg = Msg.replace(/\n/g, "<br />");
			Msg = '<h4> '+ data['author']['name'] + ', <small>' + data['author']['date'] + '</small></h4><h3> ' + Msg;
			//</h3>
		}
		$( "div#com_detail" ).html( Msg );
	}

	function getInfo(proj,value) {
		var url=proj.split(' (');
		var gurl = "https://api.github.com/repos/" + url[1].substring(0, url[1].length - 1)
			+ '/' + url[0] + "/git/commits/" + value;
		$.ajax({
			url: gurl,
			jsonp: "callback",
			dataType: "jsonp",
			success: githubSucc,
			error: function( e ) {
				$( "div#com_detail" ).html( 'Error to get commit detail' );
			}
		});
	}

	function addListener(c,t) {
		var chart=c;
		var Table=t;
		google.visualization.events.removeAllListeners(c);
		function selectHandler() {
			var selectedItem = chart.getSelection()[0];
			if (selectedItem) {
				var value = Table.getValue(selectedItem.row, 0);
				var proj = getActiveProject();
				var url = 'https://' + getProjectGurl(proj) + '/commit/' + value;
				getInfo(proj,value);
				//githubSucc(1);
				$( "span#com_sha1" ).text( value.substring(0, 12) );
				$( "span#com_url" ).html( '<a class="btn btn-success" href="' + url
					+ '"> View detail on GitHub</a>' );
				$('#com_dialog').modal("show");
			}
		}
		google.visualization.events.addListener(chart, 'select', selectHandler);
	}

	function getActiveProject () {
		var e = document.getElementById("project_div");
		return e.options[e.selectedIndex].value;
	}

	function getProjectGurl(Proj) {
		var url=Proj.split(' (');
		return 'github.com/' + url[1].substring(0, url[1].length - 1) + '/' + url[0];
	}

	function refresh(days,delta) {
		if ( days+delta < 1 || days+delta > 366 )
			return days;
		var Project = getActiveProject();
		days=days+delta;
		drawDashboard(Project, days);
		$( "span#last_days" ).text( days );
		$( "span#github_url" ).html( '<a class="btn btn-default" href="https://' + getProjectGurl(Project)
			+ '">GitHub</a>' );
		return days;
	}
</script>
<style>
/* tab color */
.nav-tabs>li>a {
	color: #000;
	border: 1px solid #ccc;
}

/* active tab color */
.nav-tabs>li.active>a, .nav-tabs>li.active>a:hover, .nav-tabs>li.active>a:focus {
	color: #fff;
	background-color: #666;
}

/* hover tab color */
.nav-tabs>li>a:hover {
	color: #222;
	border-color: #ccc;
}
</style>
</head>

<body style="padding: 10px;">
	<div class="row text-center">
		<div class="col-lg-3">
			<div class="btn-group" role="group">
				<select id="project_div" class="btn-success btn-lg dropdown-toggle btn-block"></select>
			</div>
			<div class="btn-group" role="group">
				<span id="github_url"></span>
			</div>
		</div>
		<div class="col-lg-6" style="padding-top: 10px;">
			<h4><span id="summary"></span></h4>
		</div>
		<div class="col-lg-3">
			<h4>
			<button id="day_minus" class="btn btn-success btn-lg">&nbsp;<b> - </b>&nbsp;</button> <button id="day_plus" class="btn btn-success btn-lg">&nbsp;<b> + </b>&nbsp;</button>
			<small>Last</small> <big><b><span id="last_days"></span></b></big> <small>days</small>
			</h4>
		</div>
	</div>

	<div class="row text-center">
		<div class="col-lg-12">
			<ul class="nav nav-tabs" id="dashtabs">
				<li><a data-toggle="tab" href="#tab0">Changes</a></li>
				<li><a data-toggle="tab" href="#tab1">Commits</a></li>
				<li><a data-toggle="tab" href="#tab2"><span class="glyphicon glyphicon-signal" aria-hidden="true"></span> <span class="glyphicon glyphicon-user" aria-hidden="true"></span></a></li>
				<li><a data-toggle="tab" href="#tab3"><span class="glyphicon glyphicon-th" aria-hidden="true"></span> <span class="glyphicon glyphicon-user" aria-hidden="true"></span></a></li>
			</ul>
		</div>
	</div>

    <div class="tab-content">

	<div class="row text-center">
		<div class="col-lg-3">
		</div>
		<div class="col-lg-6">
			<h4><span id="last_days_sum"></span></h4>
		</div>
	</div>
        <div id="tab0" class="tab-pane">
			<div class="row">
				<div class="col-lg-6">
					<div class="panel panel-default">
						<div class="panel-heading">Commits added by day
						</div>
						<div class="panel-body"><div id="commits_div"></div>
						</div>
					</div>
				</div>

				<div class="col-lg-6">
					<div class="panel panel-default">
						<div class="panel-heading">Size changed by day
						</div>
						<div class="panel-body"><div id="size_div"></div>
						</div>
					</div>
				</div>

				<div class="col-lg-6">
					<div class="panel panel-default">
						<div class="panel-heading">Files changed, added and removed by day
						</div>
						<div class="panel-body"><div id="files_div"></div>
						</div>
					</div>
				</div>

				<div class="col-lg-6">
					<div class="panel panel-default">
						<div class="panel-heading">Lines added and removed by day
						</div>
						<div class="panel-body"><div id="lines_div"></div>
						</div>
					</div>
				</div>
			</div>
        </div>

        <div id="tab1" class="tab-pane">
			<div class="row text-center">
				<div class="col-lg-12">
					<div class="panel panel-default">
						<div class="panel-heading">Biggest commits by changed size
						</div>
						<div class="panel-body"><div id="big_commit_div"></div>
						</div>
					</div>
				</div>
				<div id="com_dialog" class="modal fade" tabindex="-1" role="dialog" aria-labelledby="myLargeModalLabel">
				  <div class="modal-dialog modal-lg">
					<div class="modal-content">
						<div class="modal-header">
							Commit <h3><span id="com_sha1"></span></h3>
						</div>
						<div class="modal-body">
							<div id="com_detail" class="text-left"></div>
						</div>
						<div class="modal-footer">
							<span id="com_url"></span>
							<button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
						</div>
					</div>
				  </div>
				</div>
			</div>
        </div>

        <div id="tab2" class="tab-pane">
			<div class="row">
				<div class="col-lg-5">
					<div class="panel panel-default">
						<div class="panel-heading">Commits by author
						</div>
						<div class="panel-body"><div id="commit_chart_div"></div>
						</div>
					</div>
				</div>

				<div class="col-lg-7">
					<div class="panel panel-default">
						<div class="panel-heading">Top commiters by size
						</div>
						<div class="panel-body"><div id="commit_size_div"></div>
						</div>
					</div>
				</div>

				<div class="col-lg-12">
					<div class="panel panel-default">
						<div class="panel-heading">Top commiters by lines added, removed
						</div>
						<div class="panel-body"><div id="author_lines"></div>
						</div>
					</div>
				</div>
			</div>
        </div>

        <div id="tab3" class="tab-pane">
			<div class="row">
				<div class="col-lg-12">
					<div class="panel panel-default">
						<div class="panel-heading">Commits, size and lines by authors
						</div>
						<div class="panel-body"><div id="bubble_div"></div>
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>
</body>
</html>
