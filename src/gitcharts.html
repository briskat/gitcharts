<!DOCTYPE html><!-- (c) 2015 Briskat, http://www.briskat.com, License: MIT -->
<html lang="en">
<head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="Git dashboard">
    <meta name="author" content="Briskat">

    <title>Briskat - gitcharts</title>
	<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/css/bootstrap.min.css">
    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->
	<script type="text/javascript" src="https://www.google.com/jsapi"></script>
	<script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.2/jquery.min.js"></script>
	<script type="text/javascript" src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/js/bootstrap.min.js"></script>
	<script type="text/javascript">
	google.load('visualization', '1.0', {'packages':['corechart']});
	google.setOnLoadCallback(initMe);

	var days = 10;
	var actTID = 0;
	var GS = new Array(); // reuse graph

	function initMe() {
		loadProjects();
		drawSummary();
		$(window).resize(function(){ refresh(days,0); });
		$("#day_minus").click(function() { days=refresh(days,-10) });
		$("#day_plus").click(function() { days=refresh(days,10) });
		$("#project_div").change(function() { refresh(days,0); drawSummary(); });

		$(document).ready(function(){
			$('a[data-toggle="tab"]').on('shown.bs.tab', function(e){
				var act = $(e.target).attr('href'); // Get the name of active tab
				actTID = act.substring(4, act.length);
				GS = new Array();
				refresh(days,0);
			});
		});
		refresh(days,0);
	}

	function dump(obj) {
		prompt('Dump', JSON.stringify(obj));
	}

	function loadProjects() {
		var jsonData = getData("/api/p/");
		var options = $("#project_div");
		$.each(jsonData['projects'], function() {
				options.append($("<option />").val(this.name).text(this.name));
		});
	}

	function getData(url) {
		return $.ajax({
			url: url,
			dataType: "json",
			async: false
		}).responseJSON;
	}

	function drawSummary() {
		var jsonData = getData("/api/p/" + $('#project_div').val() + "/r/summary");
		var metrics=jsonData['report']['metrics'];
		$( "span#summary" ).html( ' <b>' + metrics['commits'][0] + '</b><small> commits,</small> <b>'
			+ metrics['authors'][0] + '</b><small> authors, </small> <b>~'
			+ Math.round(metrics['size'][0]/1048576) + '</b><small>MB, </small><b>~'
			+ metrics['files'][0] + '</b><small> files</small>');
	}

	function order(a, b) {
		if (b[1] == a[1]) { return 0; }
		if (b[1] > a[1]) { return 1; }
		else { return -1; }
	}
	function order_abs(a, b) {
		if (Math.abs(b[1]) == Math.abs(a[1])) { return 0; }
		if (Math.abs(b[1]) > Math.abs(a[1])) { return 1; }
		else { return -1; }
	}
	function order_2val(a, b) {
		if (b[1] == a[1] && b[2] == a[2] ) { return 0; }
		if (b[1] >= b[2] && b[1] > a[1] && b[1] > a[2] ) { return 1; }
		if (b[2] > b[1] && b[2] > a[1] && b[2] > a[2] ) { return 1; }
		else { return -1; }
	}

	function metric2Table(jsonData,xname,Report,fsort) {
		var Table = new google.visualization.DataTable();
		Table.addColumn('string', xname);
		for ( var j in Report ) {
			if ( Report[j] ) {
				Table.addColumn('number', Report[j]);
			} else {
				Table.addColumn('string', Report[j]);
			}
		}

		var metrics=jsonData['report']['metrics'];
		var rows = new Array();
		for ( var x_idx in jsonData['report']['x'] ) {
			var row=[];
			row.push(jsonData['report']['x'][x_idx]);
			for ( var j in Report ) {
				if ( Report[j] ) {
					row.push(metrics[Report[j]][x_idx]);
				} else {
					row.push('');
				}
			}
			rows.push(row);
		}
		if ( fsort ) {
			rows.sort(fsort)
		}
		Table.addRows(rows);
		return Table;
	}

	function drawDashboard(Project,days) {
			gv = google.visualization;
			var Iurl = 0;
			var Ixaxis = 1;
			var Igrid = 2;
			var tab = [
				[
					[
						"/r/last_x_days?days=" + days,
						'date',
						[
							[ gv.ColumnChart, 'commits_div', [ 'commits' ], { 'height':350 } ],
							[ gv.ColumnChart, 'size_div',    [ 'size' ], { 'height':350 } ],
							[ gv.LineChart,   'files_div',   [ 'files_c', 'files_r', 'files_a' ], { 'height':350 } ],
							[ gv.LineChart,   'lines_div',   [ 'lines_a', 'lines_r' ], { 'height':350 } ],
						]
					]
				],
				[
					[
						"/r/last_x_days_a?days=" + days,
						'author',
						[
							[ gv.PieChart, 'commit_chart_div', [ 'commits' ],
								{ 'height':350,
								},
								order
							],
							[ gv.ColumnChart, 'commit_size_div', [ 'size' ],
								{ 'height':350,
								},
								order_abs
							],
							[ gv.ColumnChart, 'author_lines', [ 'lines_a', 'lines_r' ],
								{ 'height':350,
								},
								order_2val
							]
						]
					]
				],
				[
					[
						"/r/last_x_days_a?days=" + days,
						'author',
						[
							[ gv.BubbleChart, 'bubble_div', [ 'lines_a', 'lines_r', 'size', 'commits' ],
								{
									hAxis: {title: 'Lines Added'},
									vAxis: {title: 'Lines Removed'},
									explorer: { maxZoomOut: 20 },
									'height':650,
								}
							]
						]
					]
				]
			];

			if ( GS[actTID] == undefined ) {
				var GST = new Array(); // reuse graph
				for ( var i in tab[actTID] )
					for ( var j in tab[actTID][i][Igrid] )
						GST.push(new tab[actTID][i][Igrid][j][0](document.getElementById(tab[actTID][i][Igrid][j][1])));
				GS[actTID] = GST;
			}

			var g_idx=0;
			for ( var i in tab[actTID] ) {
				var Data = getData("/api/p/" + Project + tab[actTID][i][Iurl]);
				for ( var j in tab[actTID][i][Igrid] ) {
					var Table = metric2Table(
									Data,
									tab[actTID][i][Ixaxis],
									tab[actTID][i][Igrid][j][2],
									tab[actTID][i][Igrid][j][4]
								);
					GS[actTID][g_idx++].draw(Table, tab[actTID][i][Igrid][j][3]);
				}
			}

	}

	function getActiveProject () {
		var e = document.getElementById("project_div");
		return e.options[e.selectedIndex].value;
	}

	function getProjectGurl(Proj) {
		var url=Proj.split(' (');
		return 'github.com/' + url[1].substring(0, url[1].length - 1) + '/' + url[0];
	}

	function refresh(days,delta) {
		if ( days+delta < 1 || days+delta > 366 )
			return days;
		var Project = getActiveProject();
		days=days+delta;
		drawDashboard(Project, days);
		$( "span#last_days" ).text( days );
		$( "span#github_url" ).html( '<a class="btn btn-default" href="https://' + getProjectGurl(Project)
			+ '">GitHub</a>' );
		return days;
	}
</script>
<style>
/* tab color */
.nav-tabs>li>a {
	color: #000;
	border: 1px solid #ccc;
}

/* active tab color */
.nav-tabs>li.active>a, .nav-tabs>li.active>a:hover, .nav-tabs>li.active>a:focus {
	color: #fff;
	background-color: #666;
}

/* hover tab color */
.nav-tabs>li>a:hover {
	color: #222;
	border-color: #ccc;
}
</style>
</head>

<body style="padding: 10px;">
	<div class="row text-center">
		<div class="col-lg-3">
			<div class="btn-group" role="group">
				<select id="project_div" class="btn-success btn-lg dropdown-toggle btn-block"></select>
			</div>
			<div class="btn-group" role="group">
				<a class="btn btn-info btn-lg" href="http://www.briskat.com/blog/Google-Graphs" role="button">
				<span class="glyphicon glyphicon-info-sign" aria-hidden="true"></span></a>
			</div>
		</div>
		<div class="col-lg-8">
			<h3>
			<span id="summary"></span>&nbsp;<span id="github_url"></span>
			</h3>
		</div>
	</div>

	<div class="row text-center">
		<div class="col-lg-3">
			<h3><button id="day_minus" class="btn btn-default btn-lg">&nbsp; -10 &nbsp;</button> <button id="day_plus" class="btn btn-default btn-lg">&nbsp; +10 &nbsp;</button>
			<small>Last</small> <big><b><span id="last_days"></span></b></big> <small>days</small>
			</h3>
		</div>
		<div class="col-lg-9">
			<ul class="nav nav-tabs" id="dashtabs">
				<li><a data-toggle="tab" href="#tab0">Changes</a></li>
				<li><a data-toggle="tab" href="#tab2"><span class="glyphicon glyphicon-signal" aria-hidden="true"></span> <span class="glyphicon glyphicon-user" aria-hidden="true"></span></a></li>
				<li><a data-toggle="tab" href="#tab3"><span class="glyphicon glyphicon-th" aria-hidden="true"></span> <span class="glyphicon glyphicon-user" aria-hidden="true"></span></a></li>
			</ul>
		</div>
	</div>

    <div class="tab-content">
        <div id="tab0" class="tab-pane">
			<div class="row">
				<div class="col-lg-6">
					<div class="panel panel-default">
						<div class="panel-heading">Commits added by day
						</div>
						<div class="panel-body"><div id="commits_div"></div>
						</div>
					</div>
				</div>

				<div class="col-lg-6">
					<div class="panel panel-default">
						<div class="panel-heading">Size changed by day
						</div>
						<div class="panel-body"><div id="size_div"></div>
						</div>
					</div>
				</div>

				<div class="col-lg-6">
					<div class="panel panel-default">
						<div class="panel-heading">Files changed, added and removed by day
						</div>
						<div class="panel-body"><div id="files_div"></div>
						</div>
					</div>
				</div>

				<div class="col-lg-6">
					<div class="panel panel-default">
						<div class="panel-heading">Lines added and removed by day
						</div>
						<div class="panel-body"><div id="lines_div"></div>
						</div>
					</div>
				</div>
			</div>
        </div>

        <div id="tab1" class="tab-pane">
			<div class="row">
				<div class="col-lg-5">
					<div class="panel panel-default">
						<div class="panel-heading">Commits by author
						</div>
						<div class="panel-body"><div id="commit_chart_div"></div>
						</div>
					</div>
				</div>

				<div class="col-lg-7">
					<div class="panel panel-default">
						<div class="panel-heading">Top commiters by size
						</div>
						<div class="panel-body"><div id="commit_size_div"></div>
						</div>
					</div>
				</div>

				<div class="col-lg-12">
					<div class="panel panel-default">
						<div class="panel-heading">Top commiters by lines added, removed
						</div>
						<div class="panel-body"><div id="author_lines"></div>
						</div>
					</div>
				</div>
			</div>
        </div>

        <div id="tab2" class="tab-pane">
			<div class="row">
				<div class="col-lg-12">
					<div class="panel panel-default">
						<div class="panel-heading">Commits, size and lines by authors
						</div>
						<div class="panel-body"><div id="bubble_div"></div>
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>
</body>
</html>
