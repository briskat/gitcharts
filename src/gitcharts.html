<!DOCTYPE html><!-- (c) 2015 Briskat, http://www.briskat.com, License: MIT -->
<html lang="en">
<head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta charset="utf-8">
    <meta http-equiv="cache-control" content="max-age=0">
    <meta http-equiv="cache-control" content="no-cache">
    <meta http-equiv="expires" content="0">
    <meta http-equiv="expires" content="Tue, 01 Jan 1970 1:00:00 GMT">
    <meta http-equiv="pragma" content="no-cache">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="Git dashboard">
    <meta name="author" content="Briskat">
    <meta property="og:image" content="http://www.briskat.com/img/posts/FIXME.png">
    <meta name="og:description" content="Git analytics">
    <meta name="og:title" content="Git analytics">
    <meta name="og:type" content="website">

    <title>Briskat - gitcharts</title>
	<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/css/bootstrap.min.css">
    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->
	<script type="text/javascript" src="https://www.google.com/jsapi"></script>
	<script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.2/jquery.min.js"></script>
	<script type="text/javascript" src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/js/bootstrap.min.js"></script>
	<script type="text/javascript">
	google.load('visualization', '1.0', {'packages':['corechart']});
	google.setOnLoadCallback(initMe);

	var GS = new Array(); // reuse graph
	var S = { tab : 1,
			days : 10,
		};

	function initMe() {
		var tab=parseInt(getUrlParameter('tab'));
		if (tab > 1 && tab < 5) { S['tab']=tab; }
		var days=parseInt(getUrlParameter('days'));
		if (days > 0 && days < 366) { S['days']=days; }
		loadProjects();

		$("#dashtabs li:eq("+(S['tab']-1)+") a").tab('show');
		$(window).resize(function(){ refresh(S['days'],0); });
		$("#day_minus").click(function() { S['days']=refresh(S['days'],-10); });
		$("#day_plus").click(function() { S['days']=refresh(S['days'],10); });
		$("#project_div").change(function() { refresh(S['days'],0); });
		$("#link_btn").click(function() { prompt('Paste current URL', getCurUrl()) });

		$(document).ready(function(){
			$('a[data-toggle="tab"]').on('shown.bs.tab', function(e){
				var act = $(e.target).attr('href'); // Get the name of active tab
				S['tab'] = act.substring(4, act.length);
				GS = new Array();
				refresh(S['days'],0);
			});
		});
		refresh(S['days'],0);
	//	jQuery(document).ready(function(e) { jQuery('#help_btn').trigger('click'); });
	}

	function getCurUrl() {
		var cUrl = "?proj=" + encodeURIComponent(getActiveProject()) + "&days=" + S['days'] + "&tab=" + S['tab'];

		var base = window.location.href
		if (base.indexOf("?")>-1){
			base = base.substr(0,base.indexOf("?"));
		}
		return base + cUrl.substring(0, cUrl.length);
	}

	function dump(obj) {
		prompt('Dump', JSON.stringify(obj));
	}

	function getUrlParameter(sParam,Url) {
		var sPageURL = window.location.search.substring(1);
		if ( Url ) { sPageURL = Url; }
		var sURLVariables = sPageURL.split('&');
		for (var i = 0; i < sURLVariables.length; i++) {
			var sParameterName = sURLVariables[i].split('=');
			if (sParameterName[0] == sParam) {
				return  decodeURIComponent(sParameterName[1]);
			}
		}
	}

	function loadProjects() {
		var jsonData = getData("/api/p/");
		var options = $("#project_div");
		var proj=getUrlParameter('proj');
		$.each(jsonData['projects'], function() {
			if ( this.name == proj ) {
				options.append($("<option selected/>").val(this.name).text(this.name));
			} else {
				options.append($("<option />").val(this.name).text(this.name));
			}
		});
	}

	function getData(url) {
		return $.ajax({
			url: url,
			dataType: "json",
			async: false
		}).responseJSON;
	}

	function order(a, b) {
		return b[1] == a[1] ? 0
			: b[1] > a[1] ? 1
			: -1;
	}
	function order_abs(a, b) {
		return Math.abs(b[1]) == Math.abs(a[1]) ? 0
			: Math.abs(b[1]) > Math.abs(a[1]) ? 1
			: -1;
	}
	function order_2val(a, b) {
		return ( b[1] == a[1] && b[2] == a[2] )  ? 0
			: (b[1] >= b[2] && b[1] > a[1] && b[1] > a[2] ) ? 1
			: (b[2] > b[1] && b[2] > a[1] && b[2] > a[2] ) ? 1
			: -1;
	}
	function chop(body,limit) {
		return limit > 0 ? body.slice(0,limit)
			: limit < 0 ? body.slice(limit,body.length)
			: body;
	}

	function empty_data (header) {
		var data =[['']];
		for (i = 1; i < header[0].length; i++) {
			data[0][i] = 0;
		}
		return data;
	}

	function metric2Data(jsonData,header,fields) {
		if (jsonData.length == 0) return empty_data(header);

		var body;
		if ( fields ) {
			body = $.map(jsonData, function(n,i){
				var row = new Array();
				row.push(n[0]);
				for ( var idx in fields ) {
					// round makes 0 from null values
					row.push(Math.round(n[fields[idx]]));
				}
			   return [row];
			});
		} else {
			body = jsonData;
		}

		return body;
	}

	function data2Table(header, data) {
		var dataTable = google.visualization.arrayToDataTable(header.concat(data));
		var formatter = new google.visualization.NumberFormat(
		    { negativeColor: 'red', negativeParens: true, pattern: '###,###.#'});
		for (i = 0; i < data[0].length; i++) {
			formatter.format(dataTable, i);
		}
		return dataTable;
	}


	function drawDashboard(Project,days) {
			gv = google.visualization;
			var actTID = S['tab']-1;
			var Iurl = 0;
			var Igrid = 1;
			var Ilistener = 2;
			var tab = [
				[
					[
						"/r/last_x_days?days=" + days,
						[
							[ gv.ColumnChart, 'commits_div', { 'height':350 }, [['Date','Commits']], [4] ],
							[ gv.ColumnChart, 'size_div', { 'height':350 }, [['Date','Size']], [1] ],
							[ gv.LineChart,   'files_div', { 'height':350 }, [['Date','Modified Files','Deleted Files','Added Files']], [7,6,5] ],
							[ gv.LineChart,   'lines_div', { 'height':350 }, [['Date','Lines Added','Lines Deleted']], [2,3] ]
						]
					]
				],
				[
					[
						"/r/last_x_days_c?days=" + days,
						[
							[ gv.ColumnChart, 'big_commit_div',
								{ 'height':650,
									title : 'Click on column for the detail.'
								},
								[['Date','Size']],
								[1],
								function (mydata) { mydata.sort(order_abs); return chop(mydata,12) }
							]
						],
						'listener'
					]
				],
				[
					[
						"/r/last_x_days_a?days=" + days,
						[
							[ gv.PieChart, 'commit_chart_div',
								{ 'height':350,
								},
								[['Author','Commits']],
								[4],
								function (mydata) { mydata.sort(order); return mydata }
							],
							[ gv.ColumnChart, 'commit_size_div',
								{ 'height':350,
								},
								[['Author','Size']],
								[1],
								function (mydata) { mydata.sort(order_abs); return chop(mydata,8) }
							],
							[ gv.ColumnChart, 'author_lines',
								{ 'height':350,
								},
								[['Author','Lines Added','Lines Deleted']],
								[2,3],
								function (mydata) { mydata.sort(order_2val); return chop(mydata,8) }
							]
						]
					]
				],
				[
					[
						"/r/last_x_days_a?days=" + days,
						[
							[ gv.BubbleChart, 'bubble_div',
								{
									hAxis: {title: 'Lines Added'},
									vAxis: {title: 'Lines Removed'},
									explorer: { maxZoomOut: 20 },
									'height':650,
								},
								[['Author','Lines Added','Lines Deleted','Size','Commits']],
								[2,3,1,4]
							]
						]
					]
				]
			];

			if ( GS[actTID] == undefined ) {
				var GST = new Array(); // reuse graph
				for ( var i in tab[actTID] )
					for ( var j in tab[actTID][i][Igrid] )
						GST.push(new tab[actTID][i][Igrid][j][0](document.getElementById(tab[actTID][i][Igrid][j][1])));
				GS[actTID] = GST;
			}

			var g_idx=0;
			for ( var i in tab[actTID] ) {
				var Data = getData("/api/p/" + Project + tab[actTID][i][Iurl]);
				for ( var j in tab[actTID][i][Igrid] ) {
					if ( tab[actTID][i][Igrid][j][1] == 'fake_div' ) {
						tab[actTID][i][Igrid][j][2](Data);
						break;
					}
					var data = metric2Data(
									Data,
									tab[actTID][i][Igrid][j][3],
									tab[actTID][i][Igrid][j][4]
								);
					var transform = tab[actTID][i][Igrid][j][5];
					if ( transform ) { data=transform(data); }
					var Table = data2Table(tab[actTID][i][Igrid][j][3], data);
					var chart=GS[actTID][g_idx++];
					if ( tab[actTID][i][Ilistener] ) {
						addListener(chart,Table);
					}
					chart.draw(Table, tab[actTID][i][Igrid][j][2]);
				}
			}
	}

	function githubSucc( response ) {
		var meta = response.meta;
		var data = response.data;
		var Msg = "No detail available.";
		if ( meta["X-RateLimit-Remaining"] == 0 ) {
			var d = new Date(0);
			d.setUTCSeconds(meta["X-RateLimit-Reset"]);
			Msg = 'No commit detail available from GitHub until ' + d.toString();
		} else {
			Msg = data['message'].replace(/\n\n/, "</h3><br /></br>");
			Msg = Msg.replace(/\n/g, "<br />");
			Msg = '<h4> '+ data['author']['name'] + ', <small>' + data['author']['date'] + '</small></h4><h3> ' + Msg;
			//</h3>
		}
		$( "div#com_detail" ).html( Msg );
	}

	function getInfo(proj,value) {
		var url=proj.split(' (');
		var gurl = "https://api.github.com/repos/" + url[1].substring(0, url[1].length - 1)
			+ '/' + url[0] + "/git/commits/" + value;
		$.ajax({
			url: gurl,
			jsonp: "callback",
			dataType: "jsonp",
			success: githubSucc,
			error: function( e ) {
				$( "div#com_detail" ).html( 'Error to get commit detail' );
			}
		});
	}

	function addListener(c,t) {
		var chart=c;
		var Table=t;
		google.visualization.events.removeAllListeners(c);
		function selectHandler() {
			var selectedItem = chart.getSelection()[0];
			if (selectedItem) {
				var value = Table.getValue(selectedItem.row, 0);
				var proj = getActiveProject();
				var url = 'https://' + getProjectGurl(proj) + '/commit/' + value;
				getInfo(proj,value);
				//githubSucc(1);
				$( "span#com_sha1" ).text( value.substring(0, 12) );
				$( "span#com_url" ).html( '<a class="btn btn-success" href="' + url
					+ '"> View detail on GitHub</a>' );
				$('#com_dialog').modal("show");
			}
		}
		google.visualization.events.addListener(chart, 'select', selectHandler);
	}

	function getActiveProject () {
		var e = document.getElementById("project_div");
		return e.options[e.selectedIndex].value;
	}

	function getProjectGurl(Proj) {
		var url=Proj.split(' (');
		return 'github.com/' + url[1].substring(0, url[1].length - 1) + '/' + url[0];
	}

	function refresh(days,delta) {
		if ( days+delta < 1 || days+delta > 366 )
			return days;
		var Project = getActiveProject();
		days=days+delta;
		drawDashboard(Project, days);
		$( "span#last_days" ).text( days );
		$( "span#github_url" ).html( '<a class="btn btn-default" href="https://' + getProjectGurl(Project)
			+ '">GitHub</a>' );
		return days;
	}
</script>
<style>
/* tab color */
.nav-tabs>li>a {
	color: #000;
	border: 1px solid #ccc;
}

/* active tab color */
.nav-tabs>li.active>a, .nav-tabs>li.active>a:hover, .nav-tabs>li.active>a:focus {
	color: #fff;
	background-color: #666;
}

/* hover tab color */
.nav-tabs>li>a:hover {
	color: #222;
	border-color: #ccc;
}
</style>
</head>

<body style="padding: 10px;">
	<div class="row text-center">
		<div class="col-lg-4">
			<div class="btn-group" role="group">
				<button type="button" id="help_btn" class="btn btn-info btn-lg" data-toggle="modal" data-target="#mainHelp">
				<span class="glyphicon glyphicon-question-sign" aria-hidden="true"></span>
				</button>
			</div>
			<div class="btn-group" role="group">
				<button id="link_btn" type="button" class="btn btn-info btn-lg">
				<span class="glyphicon glyphicon-link" aria-hidden="true"></span>
				</button>
			</div>
			<div class="btn-group" role="group">
				<select id="project_div" class="btn-success btn-lg dropdown-toggle btn-block"></select>
			</div>
			<div class="btn-group" role="group">
				<span id="github_url"></span>
			</div>
		</div>
		<div class="col-lg-3">
			<h4>
			<button id="day_minus" class="btn btn-success btn-lg">&nbsp;<b> - </b>&nbsp;</button> <button id="day_plus" class="btn btn-success btn-lg">&nbsp;<b> + </b>&nbsp;</button>
			<small>Last</small> <big><b><span id="last_days"></span></b></big> <small>days</small>
			</h4>
		</div>
		<div class="modal fade" id="mainHelp" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
		  <div class="modal-dialog" role="document">
			<div class="modal-content">
			  <div class="modal-header">
				<button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
				<h2 class="modal-title" id="myModalLabel">Gitcharts analytics</h2>
					views the "big picture" of git repository changes. Contact us at <b>ask at briskat.com</b>.
			  </div>
			  <div class="modal-body text-left">
						<p>Project data are refreshed from github repositories each hour.
						Use green buttons to change project or select time period.
						Click GitHub button (next to Project button) to view original project on GitHub. On commit pane click particular commit to view commit detail.
						</p>
			  </div>
			  <div class="modal-footer">
				<button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
			  </div>
			</div>
		  </div>
		</div>
	</div>

	<div class="row text-center">
		<div class="col-lg-12">
			<ul class="nav nav-tabs" id="dashtabs">
				<li><a data-toggle="tab" href="#tab1">Changes</a></li>
				<li><a data-toggle="tab" href="#tab2">Commits</a></li>
				<li><a data-toggle="tab" href="#tab3"><span class="glyphicon glyphicon-signal" aria-hidden="true"></span> <span class="glyphicon glyphicon-user" aria-hidden="true"></span></a></li>
				<li><a data-toggle="tab" href="#tab4"><span class="glyphicon glyphicon-th" aria-hidden="true"></span> <span class="glyphicon glyphicon-user" aria-hidden="true"></span></a></li>
			</ul>
		</div>
	</div>

    <div class="tab-content">
        <p></p><div id="fake_div"></div>

        <div id="tab1" class="tab-pane">
			<div class="row">
				<div class="col-lg-6">
					<div class="panel panel-default">
						<div class="panel-heading">Commits added by day
						</div>
						<div class="panel-body"><div id="commits_div"></div>
						</div>
					</div>
				</div>

				<div class="col-lg-6">
					<div class="panel panel-default">
						<div class="panel-heading">Size changed by day
						</div>
						<div class="panel-body"><div id="size_div"></div>
						</div>
					</div>
				</div>

				<div class="col-lg-6">
					<div class="panel panel-default">
						<div class="panel-heading">Files changed, added and removed by day
						</div>
						<div class="panel-body"><div id="files_div"></div>
						</div>
					</div>
				</div>

				<div class="col-lg-6">
					<div class="panel panel-default">
						<div class="panel-heading">Lines added and removed by day
						</div>
						<div class="panel-body"><div id="lines_div"></div>
						</div>
					</div>
				</div>
			</div>
        </div>

        <div id="tab2" class="tab-pane">
			<div class="row text-center">
				<div class="col-lg-12">
					<div class="panel panel-default">
						<div class="panel-heading">Biggest commits by changed size
						</div>
						<div class="panel-body"><div id="big_commit_div"></div>
						</div>
					</div>
				</div>
				<div id="com_dialog" class="modal fade" tabindex="-1" role="dialog" aria-labelledby="myLargeModalLabel">
				  <div class="modal-dialog modal-lg">
					<div class="modal-content">
						<div class="modal-header">
							Commit <h3><span id="com_sha1"></span></h3>
						</div>
						<div class="modal-body">
							<div id="com_detail" class="text-left"></div>
						</div>
						<div class="modal-footer">
							<span id="com_url"></span>
							<button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
						</div>
					</div>
				  </div>
				</div>
			</div>
        </div>

        <div id="tab3" class="tab-pane">
			<div class="row">
				<div class="col-lg-5">
					<div class="panel panel-default">
						<div class="panel-heading">Commits by author
						</div>
						<div class="panel-body"><div id="commit_chart_div"></div>
						</div>
					</div>
				</div>

				<div class="col-lg-7">
					<div class="panel panel-default">
						<div class="panel-heading">Top commiters by size
						</div>
						<div class="panel-body"><div id="commit_size_div"></div>
						</div>
					</div>
				</div>

				<div class="col-lg-12">
					<div class="panel panel-default">
						<div class="panel-heading">Top commiters by lines added, removed
						</div>
						<div class="panel-body"><div id="author_lines"></div>
						</div>
					</div>
				</div>
			</div>
        </div>

        <div id="tab4" class="tab-pane">
			<div class="row">
				<div class="col-lg-12">
					<div class="panel panel-default">
						<div class="panel-heading">Commits, size and lines by authors
						</div>
						<div class="panel-body"><div id="bubble_div"></div>
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>
</body>
</html>
